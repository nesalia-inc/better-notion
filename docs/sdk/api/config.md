# Project Configuration

This document defines the development tools and configuration for the Better Notion SDK project.

## Package Management: uv

We use **uv** as the package manager and virtual environment manager for this project.

### Why uv?

| Feature | uv | pip | poetry |
|---------|----|-----|--------|
| **Speed** | Extremely fast (written in Rust) | Slower (Python) | Moderate |
| **Dependency Resolution** | Optimized resolver | Can be slow | Moderate |
| **Lock Files** | uv.lock | requirements.txt | poetry.lock |
| **Virtual Environment** | Built-in | Separate command | Built-in |
| **Compatibility** | Compatible with pip/PyPI | Standard | Custom |
| **Caching** | Advanced caching | Basic | Custom |
| **Package Installation** | Much faster | Slower | Moderate |

### Installation

```bash
# Install uv
curl -LsSf https://astral.sh/uv/install.sh | sh
# Or on Windows
powershell -ExecutionPolicy ByPass -Script https://astral.sh/uv/ps/install.ps1

# Or with pip
pip install uv
```

### Project Setup with uv

```bash
# Initialize project (creates .python-version and uv.lock)
uv init

# Create virtual environment
uv venv

# Install dependencies
uv pip install -e ".[dev]"
```

### uv Commands

```bash
# Add dependency
uv add httpx

# Add dev dependency
uv add --dev pytest

# Install from pyproject.toml
uv sync

# Run scripts
uv run pytest

# Run Python in venv
uv run python
```

### Configuration Files

#### .python-version

```
3.10
```

Specifies Python 3.10 as the required Python version.

#### uv.lock

Lock file generated by uv containing:
- Exact versions of all dependencies
- Dependency hashes for verification
- Reproducible installs

**Note:** This file is auto-generated and should be committed to version control.

### Benefits

1. **Speed**: Dependency installation is 10-100x faster than pip
2. **Reliability**: Better dependency resolution
3. **Compatibility**: Works with existing Python ecosystem
4. **Developer Experience**: Single tool for all package management

## Testing: pytest

We use **pytest** as the testing framework with async support.

### Why pytest?

| Feature | pytest | unittest |
|---------|--------|----------|
| **Async Support** | pytest-asyncio plugin | Limited support |
| **Fixtures** | Powerful fixture system | Basic fixtures |
| **Assertions** | Rich assertion introspection | Standard asserts |
| **Plugins** | Huge ecosystem | Limited |
| **Discoverability** | Auto-discovers tests | Manual import |
| **Verbose Output** | Detailed failure messages | Basic output |

### Configuration

#### pyproject.toml

```toml
[project.optional-dependencies]
dev = [
    "pytest>=7.0",
    "pytest-asyncio>=0.21.0",
    "pytest-cov>=4.0",
    "pytest-mock>=3.10",
    "httpx-mock>=0.1.0",
]
```

#### pytest.ini

```ini
[pytest]
# Test discovery patterns
python_files = test_*.py
python_classes = Test*
python_functions = test_*

# Output options
addopts =
    -v                     # Verbose output
    --strict-markers       # Treat unknown markers as error
    --tb=short             # Short traceback format
    --cov=better_notion    # Coverage reporting
    --cov-report=html      # HTML coverage report
    --cov-report=term-missing  # Show missing lines in terminal

# Async configuration
asyncio_mode = auto       # Auto-detect async tests

# Markers
markers =
    unit: Unit tests (no external dependencies)
    integration: Integration tests (may use I/O)
    slow: Slow tests (>1 second)
```

### Test Organization

```
tests/
├── unit/                    # Fast, isolated tests
│   ├── test_http_client.py
│   ├── test_auth.py
│   ├── test_endpoints.py
│   └── test_pagination.py
├── integration/             # Tests with external dependencies
│   └── test_api_client.py
├── fixtures/                # Test data and fixtures
│   └── responses/
└── conftest.py              # Shared pytest configuration
```

### Running Tests

```bash
# Run all tests
uv run pytest

# Run only unit tests
uv run pytest -m unit

# Skip slow tests
uv run pytest -m "not slow"

# Run with coverage
uv run pytest --cov=better_notion --cov-report=html

# Run specific test file
uv run pytest tests/unit/test_http_client.py

# Run specific test
uv run pytest tests/unit/test_http_client.py::TestHTTPClient::test_request_success

# Verbose output
uv run pytest -vv

# Stop on first failure
uv run pytest -x

# Run until first failure then show detailed output
uv run pytest -x -vv
```

### Writing Tests

#### Basic Test Structure

```python
import pytest

class TestMyFeature:
    """Test suite for feature."""

    @pytest.mark.asyncio
    async def test_basic_operation(self):
        """Test basic operation."""
        # Arrange
        input_data = {...}

        # Act
        result = await operation(input_data)

        # Assert
        assert result["expected"] == "value"

    @pytest.mark.unit
    def test_sync_operation(self):
        """Test synchronous operation."""
        assert 1 + 1 == 2
```

#### Using Fixtures

```python
@pytest.fixture
async def mock_client():
    """Create mock API client."""
    api = NotionAPI(auth="test_token")
    # Setup mock
    return api

@pytest.mark.asyncio
async def test_with_fixture(mock_client):
    """Test using fixture."""
    result = await mock_client.pages.retrieve("page_id")
    assert result is not None
```

#### Async Tests

```python
@pytest.mark.asyncio
async def test_async_operation():
    """Test async operation."""
    result = await async_function()
    assert result is not None
```

#### Markers

```python
@pytest.mark.unit
def test_unit():
    """Unit test - fast, isolated."""
    pass

@pytest.mark.integration
async def test_integration():
    """Integration test - may use I/O."""
    pass

@pytest.mark.slow
async def test_slow_operation():
    """Slow test - takes >1 second."""
    await asyncio.sleep(2)
```

### Coverage

```bash
# Generate HTML coverage report
uv run pytest --cov=better_notion --cov-report=html

# Generate terminal coverage report
uv run pytest --cov=better_notion --cov-report=term-missing

# Combine HTML and terminal
uv run pytest --cov=better_notion --cov-report=html --cov-report=term-missing

# Coverage thresholds
uv run pytest --cov=better_notion --cov-fail-under=80
```

### pytest-asyncio Configuration

```python
# In conftest.py

@pytest.fixture(scope="session")
def event_loop_policy():
    """Use uvloop for async tests if available."""
    try:
        import uvloop
        return uvloop.EventLoopPolicy()
    except ImportError:
        return asyncio.DefaultEventLoopPolicy()
```

## Development Workflow

### Setup Development Environment

```bash
# Clone repository
git clone https://github.com/nesalia-inc/better-notion.git
cd better-notion

# Install uv (if not installed)
curl -LsSf https://astral.sh/uv/install.sh | sh

# Create virtual environment
uv venv

# Activate venv
# Windows
.venv\Scripts\activate
# Linux/Mac
source .venv/bin/activate

# Install dependencies
uv sync
```

### Running Tests During Development

```bash
# Quick test run
uv run pytest -x

# Run with coverage
uv run pytest --cov=better_notion

# Watch mode (requires pytest-xdist)
uv pip install pytest-xdist
uv run pytest -f
```

### Adding Dependencies

```bash
# Add runtime dependency
uv add httpx

# Add dev dependency
uv add --dev pytest-mock

# Update from pyproject.toml
uv sync
```

## Continuous Integration

### GitHub Actions

```yaml
# .github/workflows/test.yml
name: Tests

on:
  push:
    branches: [main]
  pull_request:

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Set up Python
        run: uv venv

      - name: Install dependencies
        run: uv sync

      - name: Run tests
        run: uv run pytest --cov=better_notion --cov-report=xml

      - name: Upload coverage
        uses: codecov/codecov-action@v3
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
```

## VS Code Integration

### Recommended Extensions

```json
{
  "recommendations": [
    "charliermarsh.rust-analyzer",  # If using uv with Rust
    "ms-python.python",
    "ms-python.debugpy",
    "tamasfe.even-better-toml",
    "littlefoxteam.vscode-python-test"
  ]
}
```

### VS Code Settings

```json
{
  "python.testing.pytestEnabled": true,
  "python.testing.unittestEnabled": false,
  "python.testing.pytestArgs": [
    "tests"
  ],
  "[python]": {
    "editor.defaultFormatter": "ruff.format",
    "editor.formatOnSave": true,
    "editor.codeActionsOnSave": {
      "source.organizeImports": true
    }
  }
}
```

## Linting and Formatting

### ruff (Fast Python Linter)

```bash
# Install ruff
uv add --dev ruff

# Run linter
uv run ruff check .

# Format code
uv run ruff format .

# Check and fix
uv run ruff check --fix .
uv run ruff format --fix .
```

### Configuration

```toml
[tool.ruff]
line-length = 100
select = ["E", "F", "I", "N", "W", "UP"]

[tool.ruff.format]
skip-magic-trailing-comma = false

[tool.ruff.lint.isort]
known-first-party = ["better_notion"]
```

## Pre-commit Hooks (Optional)

```bash
# Install pre-commit
uv add --dev pre-commit

# Create .pre-commit-config.yaml
cat > .pre-commit-config.yaml << 'EOF'
repos:
  - repo: https://github.com/astral-sh/ruff-pre-commit
    rev: v0.1.0
    hooks:
      - id: ruff
        args: [--fix]
      - id: ruff-format
EOF

# Install hooks
pre-commit install
```

## Environment Variables

### Development

```bash
# Optional: Set Python version
export PYTHON_VERSION=3.10

# Optional: Set test database
export NOTION_TEST_DATABASE_ID=...

# Optional: Set test token
export NOTION_TEST_TOKEN=secret_test_...
```

### CI/CD

```yaml
env:
  NOTION_API_VERSION: "2025-09-03"
```

## Troubleshooting

### Common Issues

#### uv Not Found

```bash
# Ensure uv is in PATH
export PATH="$HOME/.local/bin:$PATH"

# Or use full path
$HOME/.local/bin/uv venv
```

#### Async Tests Not Running

```bash
# Ensure pytest-asyncio is installed
uv add --dev pytest-asyncio

# Check asyncio mode
uv run pytest --collect-only | grep asyncio
```

#### Coverage Not Working

```bash
# Ensure pytest-cov is installed
uv add --dev pytest-cov

# Check if better_notion package is installed
uv pip list | grep better-notion
```

## Version Compatibility

### Python Version

- **Required**: Python 3.10+
- **Tested**: Python 3.10, 3.11, 3.12

### Platform Compatibility

- **Linux**: Fully supported
- **macOS**: Fully supported
- **Windows**: Fully supported

### uv Version

- **Minimum**: 0.1.0+
- **Recommended**: Latest stable release

## Best Practices

### 1. Always Use uv for Commands

```bash
# GOOD
uv run pytest
uv run python script.py

# AVOID (if in venv)
pytest  # May use system pytest
python script.py  # May use system Python
```

### 2. Keep Dependencies Updated

```bash
# Update dependencies
uv sync

# Update specific dependency
uv add httpx@latest
```

### 3. Run Tests Before Committing

```bash
# Quick test
uv run pytest -x

# Full test with coverage
uv run pytest --cov=better_notion --cov-report=html
```

### 4. Use Virtual Environment

```bash
# Always work in virtual environment
source .venv/bin/activate  # Linux/Mac
.venv\Scripts\activate  # Windows
```

### 5. Lock File

```bash
# Commit uv.lock for reproducible installs
git add uv.lock

# Update lock file when dependencies change
uv sync
git add uv.lock
```

## Migration Guide

### From pip + venv

```bash
# Old way
python3 -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt
pip install -r requirements-dev.txt

# New way with uv
uv venv
uv sync  # Reads from pyproject.toml
```

### From poetry

```bash
# Poetry uses pyproject.toml, so we can migrate
# Remove poetry.lock
rm poetry.lock

# Create .python-version
echo "3.10" > .python-version

# Initialize uv
uv init

# Install dependencies
uv sync
```

## Additional Resources

### Documentation

- [uv Documentation](https://github.com/astral-sh/uv)
- [pytest Documentation](https://docs.pytest.org/)
- [pytest-asyncio Documentation](https://pytest-asyncio.readthedocs.io/)

### Tools

- [ruff Documentation](https://docs.astral.sh/ruff/)
- [pre-commit Documentation](https://pre-commit.com/)
- [codecov Documentation](https://docs.codecov.com/)

## Summary

This project uses:
- **uv** for package management and virtual environments
- **pytest** for testing with async support
- **ruff** for linting and formatting
- **pytest-asyncio** for async test support
- **pytest-cov** for coverage reporting

This toolchain provides:
- Fast dependency installation and resolution
- Modern async testing capabilities
- Comprehensive code quality checks
- Excellent developer experience
